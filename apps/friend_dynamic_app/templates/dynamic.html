{% extends "base_later.html" %}
 {% load util_filter %}
 {% load dynamic_filter %}
	<title> {% block title %} 拼爱网--动态 {% endblock %} </title>
{% load staticfiles %}
{% block staticfiles %}
<link href="{{STATIC_URL}}css/card.css" rel="stylesheet">
<script type="text/javascript" src="{{STATIC_URL}}js/venobox.js"></script>
<link href="{{STATIC_URL}}css/venobox.css" rel="stylesheet">
 <link href="{% static 'css/dropzone.css' %}" type="text/css" rel="stylesheet"/>
  <script src="{% static 'js/dropzone.js' %}"></script>
{% endblock %}
{% block css %}

<style>
			textarea {
				resize: none;
			}
			#s-trend {
				width: 100%;
				height: 112px;
				margin-bottom: 17px;
			}

			.trend-list {
				width: 100%;
				border-bottom: solid 1px #7E7582;
				margin-top: 0;
			}

			.trend-name {
				position: relative;
				top: -40px;
			}

			.trend-text {
				position: relative;
				left: -40px;
				font-size: 16px;
			}

			.controlArrow {
				border-style: solid;
				position: absolute;
				left: 560px;
				top: 24px;
				border-color: rgba(0, 0, 0, 0) rgba(255, 255, 255, 0.5) rgba(0, 0, 0, 0) rgba(0, 0, 0, 0);
				border-width: 11px 10px 11px 0;
				cursor: inherit;
				transform: rotate(90deg);
				-webkit-transform: rotate(90deg);
			}

			.interact {
				position: relative;
				left: 80%;
				width: 170px;
			}

			.interact > ul > li {
				cursor: pointer;
			}

			.pic-list {
				margin-left: 60px;
			}

			.pic-list > a > img {
				width: 65px;
				height: 65px;
				display: inline-block;
			}

			.commentary-area {
				position: relative;
				left: 25%;
				width: 70%;
			}

			.commentary {
				background: none repeat scroll 0 0 rgba(255, 255, 255, 0.5);
				border-bottom: solid 1px #7E7582;
			}

			.commentary-head {
				height: 50px;
				width: 50px;
				display: inline-block;
			}

			.commentary-time, .commentary-delete {
				position: relative;
				left: 70%;
			}
			.commentary-text {
				text-indent: 2em;
			}
			.commentary-delete ,.commentary-reply{
				left: 67%;
			}
			
			#emoji-layer{
				position: absolute;	
				padding: 4px;
				background-color: #fff;
				width: 417px;
				z-index: 9999;
			}
			
			.emoji-list li:hover{
				border: 1px solid #0095CD;
			}
			
			.emoji-list li {
			    border: 1px solid #E8E8E8;
			    cursor: pointer;
			    float: left;
			    overflow: hidden;
			    padding: 3px 3px;
			    text-align: center;
			    background-color: #fff;
			}
			
			.emoji-list li > img{
				width: 26px;
				height: 26px;
			}
			
			li {
			    list-style: none outside none;
			}
			
			.publishInputBefore {
				border: 0 none;
				color: #BBBBBB;
				font-size: 14px;
				height: 72px;
				line-height: 24px;
				outline: medium none;
				overflow: auto;
				padding: 6px 12px;
				resize: none;
				width: 100%;
			}
			.publishInputArea {
				border: 2px solid #C4DAED;
				border-radius: 3px 3px 3px 3px;
				position: relative;
				width: 100%;
			}
			.publishInputBottomLeft li {
				cursor: pointer;
				height: 16px;
				line-height: 16px;
				margin-left: 8px;
				padding-left: 21px;
			}
			.publishInputBottom {
				background: none repeat scroll 0 0 #F9F9F9;
				height: 34px;
				position: relative;
				width: 100%;
				z-index: 14;
			}
			.f_gray_999 {
				color: #999999;
			}
			.fn-clear {
			}
			.fn-left {
				float: left;
			}
			.publishInputPhoto {
				background: url("{{STATIC_URL}}img/photo_icon.gif") no-repeat scroll left center rgba(0, 0, 0, 0);
			}
			.publishInputExpression {
				background: url("{{STATIC_URL}}img/pop_expression.gif") no-repeat scroll left center rgba(0, 0, 0, 0);
			}
			.publishInputVideo {
				background: url("{{STATIC_URL}}img/tag_icon.gif") no-repeat scroll left center rgba(0, 0, 0, 0);
			}
			.fn-left, .fn-right {
				display: inline;
			}
			.fn-right {
				float: right;
			}
			.publishBtn {
				margin: 4px 10px 0 0;
			}
			.btn6025 {
				height: 25px;
				line-height: 25px;
				text-align: center;
				width: 60px;
				background: #FF9283;
			}
			.wordNumber {
				margin: -2px 16px 0 0;
			}
			.wordNumber span {
				font-family: Constantia, Georgia;
				font-size: 22px;
				font-style: italic;
				font-weight: 700;
				padding: 0 2px;
			}
			.btn6025 a:link, .btn6025 a:visited {
				background: -moz-linear-gradient(center top , #FF4F86, #FF5187) repeat scroll 0 0 rgba(0, 0, 0, 0);
				border: 1px solid #F9F9F9;
				color: #FFFFFF;
				display: block;
				height: 25px;
				text-decoration: none;
				width: 60px;
			}
			.publishInputUploadPhotoArea {
				display: none;
			}
			.publishInputUploadVideoArea {
				display: none;
			}
		</style>
<script type="text/javascript">
        Dropzone.options.myDropzone = {

      		  // Prevents Dropzone from uploading dropped files immediately
      		  autoProcessQueue: true,
      		  maxFilesize:10, // MB
      		  dictFileTooBig: "图片不得大于 10MB" ,
      		  //文件类型
      		  acceptedFiles:".png,.jpg,.JPG",
      		  //文件类型错误提示
      		  dictInvalidFileType:"照片格式不符合规范",
      		  //uploadMultiple:true,
      		  //最大文件数
      		  maxFiles:4,
      		  //删除文件
      		 addRemoveLinks:"dictRemoveFile",
      		 dictRemoveFile:"删除文件",
      		 dictResponseError:"服务器无响应",
      		  init: function() {
      		  //  var submitButton = document.querySelector("#submit-all")
      		      myDropzone = this; // closure

      		    //submitButton.addEventListener("click", function() {
      		  //    myDropzone.processQueue(); // Tell Dropzone to process all queued files.
      		    
      		   // });
                 
      		  
      		    // You might want to show the submit button only when 
      		    // files are dropped here:
      		    	
      		    this.on("addedfile", function() {
      		      // Show submit button here and/or inform user to click it.
      		       $('#type').val('2');
      		    });
      		   this.on("maxfilesexceeded", function(file) { this.removeFile(file); });
      		   
      		    this.on("success", function(file, response) {
      		    	file.pictureName = response; // If you just return the ID when storing the file
      		      // You can also return a JSON object then the line would
      		      // look something like this:
      		      //
      		      // file.serverId = response.id;
      		      //
      		      // In that case make sure that you respond with the mime type
      		      // application/json
      		    });
      		    this.on("removedfile", function(file) {
      		      if (!file.pictureName) { return; } // The file hasn't been uploaded
      		      $.getJSON("/dynamic/deletePhoto/",{pictureName:file.pictureName}); // Send the file id along
      		    });

      		  }
      		};
</script>
<script type="text/javascript">
var userName="{{user.username}}"
var userId="{{user.id}}"
$(document).ready(function(){
	//字数限制
	$("#publishTextArea").keydown(function(){
	   var curLength=$("#publishTextArea").val().length;
	   var limitLenght=200
	   if(curLength>=limitLenght){
	      var num=$("#publishTextArea").val().substr(0,limitLenght);
	      $("#publishTextArea").val(num);
	        alert("超过字数限制，多出的字将被截断！" );
	       }
	     else{
	      $("#reserve").text(limitLenght-$("#publishTextArea").val().length)
	      }
	});
	
	$('#publishInputPhoto').bind('click',function(){
	    $('#publishInputUploadPhotoArea').toggle()
	    $('#publishInputUploadVideoArea').hide()
	    
	})
	
	$('.public').click(function(){
		var content= $("#publishTextArea").val();
	       var length= $.trim(content).length
	       if (length >0){
	           $('#form1').submit();
	       }
	       else{
	           alert("内容不能为空！")
	       };
	});
	
	
	//发表评论
	$(".reply").click(function(){
	    var reply=$(this)
		var dynamicId=$(this).closest('.card_panel').find('#dynamicId').val()
		var receiverId=$(this).parent().find('#receiverId').val()
		var content=$(this).closest('.publishInputArea').find('#publishTextArea').val()
	      $.getJSON('/dynamic/comment/',{dynamicId:dynamicId,receiverId:receiverId,content:content},function(data){
	        if (data['type']=='success'){
	          init_comment(data['dynamicCommentList'],dynamicId)
	          reply.closest('.publishInputArea').find('#publishTextArea').val('')
	          reply.parent().find('#receiverId').val("")
	        }else if(data['type']=='error'){
	            alert("删除失败")
	        }else{
	            window.location.href='http://127.0.0.1:8000/';
	        }
	    })
	});
	
});

function commentary_reply(){
	var commentId=$(this).parent().find('.commentId').val()
	var reviewerName=$(this).parent().find('.reviewerName').val()
	var reviewerId=$(this).parent().find('.reviewerId').val()
	var areaText=$(this).closest('.commentary-area')
	areaText.find('#receiverId').val(reviewerId)
	areaText.find('#publishTextArea').val('回复@'+reviewerName+":")
};
//添加移除赞
function agree(id){
    agreeStatus=$('#agree_'+id).val();
    agreeString= $('#argeeName_'+id).html()
    agreeNum=agreeString.substring(agreeString.indexOf('(')+1,agreeString.indexOf(')'))
    agreeNum=parseInt(agreeNum)
    $.getJSON('/dynamic/agree/',{id:id},function(data){
        if (data['type']=='delSuccess'){
            $('#argeeName_'+id).html("赞("+(agreeNum-1)+")")
            $('#agree_'+id).val("False");
           // $('#argeeNum_'+id).text(argeeNum-1);
        }else if (data['type']=='addSuccess'){
            $('#argeeName_'+id).html("已赞("+(agreeNum+1)+")")
            $('#agree_'+id).val("True");
           // $('#argeeNum_'+id).text(argeeNum+1);
        }else if(arg['type']=='error'){
            alert("删除失败")
        }else{
            window.location.href='http://127.0.0.1:8000/';
        }
    });
}

//删除动态
function del_dynamic(id,type){
    $.getJSON('/dynamic/delDynamic/',{id:id,type:type},function(data){
        if (data['type']=='success'){
            $('#dynamic_'+id).remove()
        }else if(data['type']=='error'){
            alert("删除失败")
        }else{
       window.location.href='http://127.0.0.1:8000/';
}
});
};


//初始化评论
function init_comment(commentList,dynamicId){
	$(commentList).each(function(){
		var comment=$('.comment_clone').clone()
		comment.removeClass('comment_clone')
		comment.find('.commentary-head').attr('src','/media/'+this.reviewerAvatarName+'-60.jpeg')
		comment.find('.commentary-text').html(this.content)
		if(this.receiverName==null ){
			comment.find('.commentary-username').html(this.reviewerName+'：')
		}else{
			comment.find('.commentary-username').html(this.reviewerName+'回复：'+this.receiverName)
		}
		if(userId==this.reviewerId){
			comment.append('<a class="commentary-delete" href="javascript:void(0);">删除</a>')
			comment.find('.commentary-delete').bind("click",del_comment);
			
		}else{
			comment.append('<a class="commentary-reply" href="javascript:void(0);">回复</a>')
			comment.find('.commentary-reply').bind("click",commentary_reply);
		}
		//comment.find('.commentary-time').html(this.commentTime)
		comment.append('<span class="commentary-time">'+this.commentTime+'</span>')
		comment.find('.commentId').val(this.id)
		comment.find('.reviewerName').val(this.reviewerName)
		comment.find('.reviewerId').val(this.reviewerId)
		comment.find('.commentary-reply').bind("click",commentary_reply);
		comment.show()
		$('#comment_'+dynamicId).find('.commentary-list').append(comment)
	})
};

//删除评论
function del_comment(){
	var comment=$(this)
	commentId=comment.parent().find('.commentId').val();
	 $.getJSON('/dynamic/del_comment/',{commentId:commentId},function(data){
	        if(data['type']=='success'){
	        	comment.parent().remove()
	            alert('删除成功！')
	        }else if(data['type']=='error'){
	        	 alert(data['msg'])
	        }
	    })
};
</script>
{% endblock %}
{% block logo %}
{% endblock %}
{% block content %}
<div class="container">
				<div class="row" style="margin-top:63px;">
					<div class="col-md-3">
						<div class="user_info card_panel">
						<div class="head {% ifequal gender 'M'%}head_boy{%else%}head_girl{%endifequal%}" style="margin:4px;height:60px;width:60px;">
				<a href="/user/user_profile/"><img alt="140x140" src="{{MEDIA_URL}}{{avatar_name}}-60.jpeg"/></a>
				</div>
				<a href='/user/user_profile/#self_info'><div class="name">{{user.username}}</div></a>
				<hr/>
				<p style="margin:20px 0 20px 20px;">搬砖砌墙敲代码，只为买瓶哇哈哈。</p>
			</div>
			<div class="sns_info card_panel">
				<table class="table">
					<tbody>
					  <tr>
						<td><i class="icon_follow"></i></td>
						<td><a href="/user/follow/1">关注</a></td>
						<td><a id="myFollow" href="/user/follow/1">{{myFollow}}</a></td>
					  </tr>
					  <tr>
						<td><i class="icon_fans"></i></td>
						<td><a href="/user/follow/2">粉丝</a></td>
						<td><a id="fans" href="/user/follow/2">{{fans}}</a></td>
					  </tr>
					  <tr>
						<td><i class="icon_mutual_like"></i></td>
						<td><a href="/user/follow/3">相互关注</a></td>
						<td><a id="follow" href="/user/follow/3">{{follow}}</a></td>
					  </tr>
					</tbody>
				</table>
			</div>

						<div class="send_pic card_panel"></div>
					</div>
					<div class="col-md-9">
						<div id="s-trend" class="card_panel">
							<form action="" id="form1"   name="form1" method="POST">{% csrf_token %}
								<input type="hidden" id="type" name="type" value="1">
								<div class="publishInputArea">
									<textarea id="publishTextArea" class="publishInputBefore" name="content" style="color: rgb(0, 0, 0); height: 72px;"></textarea>
									<div class="publishInputBottom fn-clear f_gray_999">
										<div class="fn-clear">
											<ul class="publishInputBottomLeft fn-left" style="list-style: none outside none;">
												<li id="publishInputPhoto" class="publishInputPhoto fn-left">
													照片
												</li>
												<li class="publishInputExpression fn-left">
													表情
												</li>
												<li id="publishInputVideo" class="publishInputVideo fn-left">
													视频
												</li>
											</ul>
										</div>
										<div class="fn-right">
											<p class="btn6025 publishBtn fn-right">
												<a  id="submit-all" href="javascript:void(0);" class="public">
													发布
												</a>
											</p>
											<p class="wordNumber fn-right">
												还能输入
												<span id="reserve">199</span>
												字
											</p>
										</div>
									</div>
								</div>
							</form>
							<div class="publishInputUploadPhotoArea" id="publishInputUploadPhotoArea">
                            <form class="dropzone" id="my-dropzone" action="/dynamic/updatePhoto/" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                             </form>
       </div>
						</div>
						
						{%for dynamic in friendDynamicList%}
						<div id="dynamic_{{dynamic.id}}" class="card_panel trend-list">
						    <input type="hidden" id="publishUserId" value="{{dynamic.publishUser.id}}">
						    <input type="hidden" id="dynamicId" value="{{dynamic.id}}">
							<div class="head head_boy" style="margin:4px;height:70px;width:70px;">
								<img alt="140x140" src="{{MEDIA_URL}}{{dynamic.get_profile}}-110.jpeg"/>
							</div>
							<span class="name trend-name">{{dynamic.publishUser.username}}</span>
							<span class="trend-text">{{dynamic.content}}</span>
							{%ifequal dynamic.type 2 %}
							<div class="pic-list">
							    {%for photo in dynamic.data%}
							    <a class="venobox" data-gall="gall1" href="{{MEDIA_URL}}images/{{photo}}" title="">
								<img src="{{MEDIA_URL}}images/{{photo}}" style="width: 70px; height: 70px;">
								</a>
								{%endfor%}
							</div>
							{%endifequal%}
							<div class="interact">
								<ul class="list-inline">
									<li>
									 {%ifequal argeeList|get_list_number:forloop.counter0 True%} 
									 <a id="argeeName_{{dynamic.id}}" href="javascript:void(0)" onclick="agree({{dynamic.id}})">已赞({{dynamic.argeeNum}})</a>
                                     {%else%}
                                     <a id="argeeName_{{dynamic.id}}" href="javascript:void(0)" onclick="agree({{dynamic.id}})">赞({{dynamic.argeeNum}})</a>
                                     {%endifequal%}      
									</li>
									<li class="comment" href="#comment_{{dynamic.id}}">
										<span><a id="show_comment_{{dynamic.id}}" href="javascript:void(0)">评论({{dynamic.commentNum}})</a></span>
									</li>
									{%ifequal dynamic.publishUser user %} 
									<li>
										 <a href="javascript:void(0)" onclick="del_dynamic({{dynamic.id}},{{dynamic.type}})">删除</a>
									</li>
									{%endifequal%}
								</ul>
							</div>

							<div id="comment_{{dynamic.id}}" class="commentary-area" style="display: none;">
								<div class="controlArrow"></div>
								<div class="commentary-list">
								</div>
								<div class="publishInputArea">
									<textarea id="publishTextArea" class="publishInputBefore" name="content" style="color: rgb(0, 0, 0); height: 52px;"></textarea>
									<div class="publishInputBottom fn-clear f_gray_999">
										<div class="fn-clear">
											<ul class="publishInputBottomLeft fn-left" style="list-style: none outside none;">
												<li class="publishInputExpression fn-left">
													表情
												</li>
											</ul>
										</div>
										<div class="fn-right">
											<p class="btn6025 publishBtn fn-right">
											 <input type="hidden" id="receiverId" value="">
												<a  id="submit-all" href="javascript:void(0);" class='reply'>
													回复
												</a>
											</p>
											<p class="wordNumber fn-right">
												还能输入
												<span id="reserve">199</span>
												字
											</p>
										</div>
									</div>
								</div>

							</div>
						</div>
						{%endfor%}
					</div>
				</div>
			</div>
			<div id="emoji-layer" style="display: none;">
			<div class="controlArrow" style="border-color: rgba(0, 0, 0, 0) rgba(255, 255, 255, 1) rgba(0, 0, 0, 0) rgba(0, 0, 0, 0); left: 20px;"></div>
			<ul class="emoji-list"></ul>
		</div>
			<div class="commentary comment_clone" style="display: none;">
			    <input type="hidden" class="commentId" value="">
			    <input type="hidden" class="reviewerName" value="">
			    <input type="hidden" class="reviewerId" value="">
				<div class="commentary-user">
				   <img class="commentary-head" src="">
				   <span class="commentary-username"></span>
				</div>
				<p class="commentary-text"></p>
			</div>
          <script>
            //显示评论
			$('.comment').click(function(){
				href = $(this).attr('href');
				if ($(href).is(":hidden")){
					var dynamicId= href.substring('#comment_'.length)
					$('#comment_'+dynamicId).find('.commentary-list').children().remove();
					var publishUserId=$('#dynamic_'+dynamicId).find('#publishUserId').val()
					$.getJSON('/dynamic/show_comment',{id:dynamicId,publishUserId:publishUserId},function(data){
						init_comment(data,dynamicId)
						$(href).show('slow');
					 })
				}else{
					$(href).hide('slow')
				}
			});
			for(i=0;i<=95;i++){
				$('.emoji-list').append('<li action-text="[emoji]"><img src="{{STATIC_URL}}img/48x48/'+i+'.gif"/></li>');
			}
			
			venobox();
			function venobox() {
				$('.venobox').venobox({
					numeratio : true,
					border : '0'
				});
				$('.venoboxvid').venobox({
					bgcolor : '#000'
				});
				$('.venoboxframe').venobox({
					framewidth : '400px',
					frameheight : '551px',
					border : '6px',
				});
				$('.venoboxinline').venobox({
					framewidth : '300px',
					frameheight : '250px',
					border : '6px',
					bgcolor : '#f46f00'
				});
				$('.venoboxajax').venobox({
					framewidth : '400px',
					frameheight : '551px',
					border : '30px;'
				});
			}
			
			$('.publishInputExpression').click(function(){
				var obj = $(this);
				var offset = obj.offset();   
				var left = offset.left+10;
				var top = offset.top+30;
				$('#emoji-layer').css({left:left,top:top});
				$('#emoji-layer').toggle();
			});
		</script>
{% endblock %}