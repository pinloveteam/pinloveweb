<!DOCTYPE HTML>
<html>
<head>
<style type="text/css">
body{
    margin:0px;
    overflow:hidden;
    background-color:#fff5eb;
}

.kineticjs-content{
	margin: 100px;
	background-color:#fff;
	border-radius: 50%;
	filter:progid:DXImageTransform.Microsoft.Shadow(color=#909090,direction=120,strength=4);/*ie*/
	-moz-box-shadow: 2px 2px 10px #909090;/*firefox*/
	-webkit-box-shadow: 2px 2px 10px #909090;/*safari或chrome*/
	box-shadow:2px 2px 10px #909090;/*opera或ie9*/
}
.card{
	height:260px;
	width:200px;
	border: 1px solid rgba(255, 255, 255, 0.6);
	background: none repeat scroll 0 0 rgba(255, 255, 255, 0.3);
}

.head{
	width: 104px;
	height: 104px;
	border-radius: 50%;
	margin-left:45px;
}

button{
	margin-top:30px;
	margin-left:60px;
}

.head_girl{
	border:2px solid rgba(255, 102, 51, 0.6);
}

.tag,.name{
	text-align:center;
}
</style>
<script type="text/javascript" src="{{STATIC_URL}}js/kinetic-v5.0.0.js"></script>  
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.min.js"></script>

</head>
<body onload="loadStage()">
    <div id="container"></div>
    <ul class="list-inline" style="position: absolute; left: 900px; top: 100px; float: left;">
		<li class="active">请输入你的幸运数字:</li>
		<li><input id="num" type="text"/></li>
	</ul>
    
	<button id="btn1" style="position: absolute; left: 900px; top: 200px; cursor: pointer; float: left; display: block;" onclick="StartGame();">开始匹配</button>
	<button id="btn2" style="position: absolute; left: 900px; top: 200px; cursor: pointer; float: left; display: none;" onclick="loadStage();">在玩一次</button>
<div id="card" style="position: absolute;left: 220px; top: 150px;display:none;">
<div class="card">
    <input type="hidden" id="userId" value=""></div>
	<div class="head head_girl">
		<img src=".\img\image1.jpeg" class="img-circle">
	</div>
	<div class="name" title="22">
		<h3><strong>王雪</strong></h3>
	</div>
	<div class="tag">
		<span>24岁</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<span>杭州</span>
	</div>
	<button id="btn" onclick="facebook_add_friend()">添加好友</button>
	<button id="btn" onclick="facebook_send_message()">打招呼</button>
<script type="text/javascript">
var appId='400350543428768'
var selectedPieces = new Array(),
	piecesArray=new Array();
var pieces = 8,
	size = 500,
	add = 4;
	
var color = new Array("#aeffae","#a292ff","#aeffae","#a292ff","#aeffae","#a292ff","#aeffae","#a292ff","#aeffae","#a292ff");
var position = new Array({X:add,Y:size/2+add},{X:size/2-size/4*Math.sqrt(2)+add,Y:size/2-size/4*Math.sqrt(2)+add},{X:size/2+add,Y:add},{X:size/2+size/4*Math.sqrt(2)+add,Y:size/2-size/4*Math.sqrt(2)+add},{X:size+add,Y:size/2+add},{X:size/2+size/4*Math.sqrt(2)+add,Y:size/2+size/4*Math.sqrt(2)+add},{X:size/2+add,Y:size+add},{X:size/2-size/4*Math.sqrt(2)+add,Y:size/2+size/4*Math.sqrt(2)+add},{X:add,Y:size/2+add});

function Trim(str){
    return str.replace(/(^\s*)|(\s*$)/g, ""); 
}
     
function loadStage() {
    var stage = new Kinetic.Stage({
		container: "container",
		width: 508,
		height: 508
        });
    layer = new Kinetic.Layer();
	for(i=0;i<pieces;i++){
		piecesArray[i] = new Object();
		piecesArray[i].shape=new Kinetic.Shape({
            drawFunc: function(i){
                return function(context) {
					context.beginPath();
					context.moveTo(position[i].X,position[i].Y);
					context.arc(size/2+4,size/2+4,size/2,Math.PI+Math.PI/4*i,Math.PI+Math.PI/4*(i+1));
					context.lineTo(size/2+4,size/2+4);
					context.lineTo(position[i].X,position[i].Y);
					context.fillStrokeShape(this);
                    }
                 }(i),
					fill: color[i],
					id:i,
					opacity:0.5,
					stroke: "#ffffff",
					strokeWidth: 4,
					draggable: false
                    });
//		piecesArray[i].shape.disableStroke();
  		piecesArray[i].shape.on("mousedown", function(){
  		this.setOpacity(0.5/this.getOpacity());
//		this.setStrokeEnabled(!this.getStrokeEnabled());
  		layer.batchDraw();
         }); 
        layer.add(piecesArray[i].shape);
	}
	stage.add(layer);
        }

       var index=0,           //当前亮区位置
       prevIndex=0,          //前一位置
       Speed=300,           //初始速度
       Time,               //定义对象
       EndIndex=0,        //决定在哪一格变慢
       cycle=0,          //转动圈数   
       EndCycle=0,      //计算圈数
       flag=false,     //结束转动标志 
       quick=0,     //加速
       piece = [];
        
       function StartGame(){
	     clearInterval(Time);
         cycle=0;
         flag=false;
         //EndCycle=Math.floor(Math.random()*4);
         EndCycle=3;
         Time = setInterval(Star,Speed);
         num = $('#num').val();
         $.getJSON("/game/jigsaw/",{number:num,uid:{{uid}}},function(data) {
				if(data['login']=='invalid'){window.location =data['redirectURL'];}
		  		if(data[0]=='0'){$('#card').find('.card').html('没有匹配用户');}
				if(data[0]=='1'){$('#card').find('.card').html('不能再玩来，明天再来');}
				if(data[0]=='2'){
					$('#card').find('#userId').val(data[2]['uid']);
					$('#card').find('.img-circle').attr('src',data[2]['avatar']);
				  	$('#card').find('strong').html(data[2]['username']);
				  	$('#card').find('.age').html(data[2]['age']).next().html(data[2]['city']);
				}
				clearInterval(Time);
				piece = data[1];
				EndIndex = piece[piece.length-1];
				Time = setInterval(Star,Speed);
				
				$('#card').show('slow');
				//$('#count').html('游戏次数:'+data['count']);
				//$('#btn2').show();
				//$('#btn1').hide();
	 });
        }
        function Star(NUM){
            if(flag==false){
              //走五格开始加速
             if(quick==5){
                 clearInterval(Time);
                 Speed=100;
                 Time=setInterval(Star,Speed);
             }
             //跑N圈减速
             if(cycle==EndCycle+1){
                 clearInterval(Time);
                 Speed=300;
                 flag=true;       //触发结束
                 Time=setInterval(Star,Speed);
             }
            }
            
            if(index>=piecesArray.length){
                index=0;
                cycle++;
            }
            
           //结束转动并选中号码
         if(flag==true && cycle==EndCycle+1 && index==parseInt(EndIndex)){ 
          quick=0;
          clearInterval(Time);
            }
            if(index>0)
                prevIndex=index-1;
            else{
                prevIndex=piecesArray.length-1;
            }
            piecesArray[index].shape.opacity(1);
				
            if(cycle > EndCycle){
              if(piece.concat(prevIndex).unique5().sort().toString()!=piece.sort().toString()){
            	piecesArray[prevIndex].shape.opacity(0.5);
               }
            }else{
            	piecesArray[prevIndex].shape.opacity(0.5);
            }

            layer.batchDraw();
            index++;
            quick++;
        }
              
       Array.prototype.unique5 = function() {
	    var res = [], hash = {};
	    for(var i=0, elem; (elem = this[i]) != null; i++)  {
	        if (!hash[elem])
	        {
	            res.push(elem);
	            hash[elem] = true;
	        }
	    }
	    return res;
	}       
	$(document).ready(function(){
		$('#btn1').click(function(){
			//$(this).hide();	
		});
		
		$('#btn2').click(function(){
			$(this).hide();
			$('#card').hide();
			$('#btn1').show();
		});
	});
	
</script>
<script>
$(document).ready(function() {
	   var appId='400350543428768'
	  $.ajaxSetup({ cache: true });
	  $.getScript('//connect.facebook.net/en_UK/all.js', function(){
	    FB.init({
	      appId:appId,
	    });     
	  });
	});
	
//用facebook私信
function facebook_send_message() {
	var userId=$('#userId').val()
    FB.ui({
        app_id:appId,
        method: 'send',
        name: "拼爱 ",
        link: 'http://www.pinlove.com/',
        to:userId,

    });
}
//添加好友
function facebook_add_friend() {
	var userId=$('#userId').val()
FB.ui(
	     { 
	      method: 'friends', 
	      id:userId
	     }, 
	     function(param){

	      console.log(param);

	     }
	    );
};
</script>
</body>
</html>