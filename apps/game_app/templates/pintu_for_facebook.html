<!DOCTYPE HTML>
<html>
<head>
<link href="{{STATIC_URL}}css/venobox.css" rel="stylesheet">
<style type="text/css">

body{
	font-family: Helvetica, Tahoma, Arial, STXihei, "华文细黑", "Microsoft YaHei", "微软雅黑", SimSun, "宋体", Heiti, "黑体", sans-serif;
    margin:0px;
    overflow:hidden;
    background-color:#fff5eb;
}

.kineticjs-content{
	position: absolute;
	top:100px;
	left:100px;
	background-color:#fff;
	border-radius: 50%;
	filter:progid:DXImageTransform.Microsoft.Shadow(color=#909090,direction=120,strength=4);/*ie*/
	-moz-box-shadow: 2px 2px 10px #909090;/*firefox*/
	-webkit-box-shadow: 2px 2px 10px #909090;/*safari或chrome*/
	box-shadow:2px 2px 10px #909090;/*opera或ie9*/
}

#card,#nouser,#game_count_end{
	background-color: #FFF9D9;
    border: 2px solid #000000;
    height: 400px;
    left: 160px;
    position: absolute;
    top: 140px;
    width: 300px;
}
#nouser,#game_count_end{
	text-align: center;
}

.head{
	width: 80px;
	height: 80px;
	margin-left:30px;
	display: inline-block;
}

.head_ask_friends{
   width: 50px;
	height: 50px;
	margin-left:35px;
	display: inline-block;
}
.img-circle,.head,.head_ask_friends,.record-user{
	border-radius: 50%;
}
.record-user{
	width: 50px;
	height: 50px;
	margin-bottom: 20px;
	position: relative;
	left:-26px;
}
#request{
	position: relative; 
	left: -10px;
}

button{
	margin-top:30px;
	margin-left:60px;
	position: absolute; 
	left: 900px; 
	top: 200px; 
	cursor: pointer; 
	float: left; 
	display: block;
}

#buy_page{
	position: absolute; 
	left: 560px; 
	top: 130px; 
	width: 400px;
	height: 400px;
	background-image: url({{STATIC_URL}}img/拼图-84.jpg);
}

.num,.num1,.num3,.num4{
	position: absolute; 
	top: 30px; 
	font-size:20px;
	margin-left: 18px;
}
.num1{
	top: 20px;
	margin-left: 8px;
}

.num2{
	position:relative;
	top: -18px;
	margin-left: 0px;
}

.num3{
	top:15px;
	left:30px;
	font-size:35px;
	color: #ff0000;
	font-weight:bold;
}

.button_type_1,.button_type_2,.try_again,.share{
	position:absolute;
	padding: 15px 15px 15px 20px;
	display: inline-block;
	top: -5px;
	left: 240px;
	width: 40px;
	height: 20px;
	background-image: url({{STATIC_URL}}img/按钮-16.png);
	background-repeat:no-repeat;
	cursor: pointer;
	text-align: center
}

.button_type_2,.share,.try_again{
	top: 370px;
	left: 360px;
	width: 92px;
	background-image: url({{STATIC_URL}}img/按钮-65.png);
}

.button_type_3{
	position:absolute;
	width: 55px;
	height: 55px;
	display: inline-block;
	cursor: pointer;
	text-align: center
}
.checkbox,#checkbox1{
	position:absolute;
	top: 30px;
	left: 200px;
}

#checkbox1{
	top: 385px;
	left: 60px;
	cursor: pointer;
}
#hi{
	top:350px;	
	left: 20px;
}

#friend{
	top:350px;	
	left: 200px;
}
.buy{
	margin-top: 30px;
	width: 340px;
	height: 40px;
	padding-top: 5px;
	margin-left: 28px;
	color: #ff5a39;
	font-size:26px;
	text-align:center;
	background-color: #ffdd71;
}
.close,.recevie_close{
	position:absolute;
	top: -3%;
	left:96%;
	width: 32px;
	height: 32px;
	background-image: url({{STATIC_URL}}img/拼图-61.png);
	cursor: pointer;
}

.online,.outline{
    position:absolute;
	top: 70%;
	left:73%;
	width: 32px;
	height: 32px;
	cursor: pointer;
	background-image: url({{STATIC_URL}}img/拼图-76.png);
	background-repeat:no-repeat;
}
.outline{
background-image: url({{STATIC_URL}}img/拼图-77.png);
}

.text-orange{
	color: #ff641f;
}

.count{
	margin: 10px;
	padding: 10px;
	width: 110px;
	height: 30px;
	/*background-color: #ffdd71;
	border: solid 1px #ef3638;*/
	background-image:url({{STATIC_URL}}img/拼图-87.png);
	border-radius: 50px;
}
.head_girl{
	border:2px solid #f79421;
}

.head_boy{
	border:2px solid #2afeef;
}

.tag,.name{
	text-align:center;
}

.name_girl,.name_boy,.name_girl_invite,.name_boy_invite{
	position:absolute;
	font-size:16px;
	color: #f79421;
	top: 30px; 
	left: 120px;
}
.name_girl_invite,.name_boy_invite{
  top: 10px; 
}

.name_boy{
	color: #2afeef;
}

#users,#recevie_users{
    height: 270px;
    overflow-x: hidden;
    overflow-y: scroll;
    position: relative;
    top: 100px;
}

.user{
	width: 240px;
	position: relative;	
	display: inline-block;
	margin-right: 30px;
	margin-left: 30px;
	margin-top: 20px;
	background-color: #FFFFFF;
	border: solid 1px #b3b3b3;
	filter:progid:DXImageTransform.Microsoft.Shadow(color=#909090,direction=120,strength=4);/*ie*/
	-moz-box-shadow: 2px 2px 5px #909090;/*firefox*/
	-webkit-box-shadow: 2px 2px 5px #909090;/*safari或chrome*/
	box-shadow:2px 2px 5px #909090;/*opera或ie9*/
	cursor: pointer;
}
#buy_page ul{
  margin-top: 100px;
}
#buy_page li {
	position: relative;
	list-style-type:none;
	margin-top: 30px;
}

.push{
	cursor: pointer;
	position: absolute;
	left: 245px; 
	top: 235px;
}

#game_name{
	position:absolute;
	top:15px;
	left:100px;
}

#invite,#recevie{
	height: 440px;
	width: 641px;
	position:absolute;
	top:100px;
	left:230px;
	background-image: url({{STATIC_URL}}img/接受邀请-59.jpg);
}

#pre,#next{
	position:absolute;
	top:400px;
	left:130px;
	cursor: pointer;
}

#next{
	left:430px;
}
.information {
    border: 2px solid #AFF0FF;
	background-color: #FFFFFF;
    height: 50px;
    left: 560px;
    position: absolute;
    top: 200px;
    width: 100px;
}
.msg{
  display:block;
 font-size: 17px;
 text-align:center;
  padding:10px 0 ;  
  color:#6FD1EF
}
.num4{
     top:20px;
	left:130px;
	font-size:35px;
	color: #ff0000;
	font-weight:bold;
}

/* photo tab */
.hoverbox
{
	margin-top: 10px;
	cursor: default;
	list-style: none;
}

.hoverbox a
{
	cursor: default;
}

.hoverbox a .preview
{
	display: none;
}


.hoverbox img
{
    height: 70px;
    vertical-align: top;
    width: 70px;
	max-width: 150px;
}

.hoverbox li
{
	color: inherit;
	display: inline;
	float: left;
	margin: 1px;
	position: relative;
}

.icon_profile,.icon_photo{
	background: url("{{STATIC_URL}}img/profile.png") no-repeat;
	margin-right:3px;
	display: inline-block;
    height: 32px;
    width: 32px;
}
.icon_photo{
	background-image: url("{{STATIC_URL}}img/photo.png");
}

#tab{
	position: absolute;
	top: 340px;
	left: 20px;
}

#record{
	position: absolute;
	top:0px;
	left:-45px;
	width: 100px;
	height: 100%;
	background-color: #ffd2d4;
	border: solid 1px #f4c696;
	transition: 1s;
	overflow: scroll;
	overflow-x: hidden;
}

#record-cover{
	position: absolute;
	top:0px;
	left:38px;
	width: 20px;
	height: 100%;
	background-color: #ffd2d4;
	transition: 1s;
}


.record-user-list li{
	list-style-type:none;
}

#tab div{
	display: inline-block;
	margin-left: 60px;
}
.recommend_hisotry{
    position:absolute;
	top:20px;
	right:30px;
}
.text-black{
	position: relative;
	top:30px;
	margin-top: 20px;
	font-size: 20px;
	Line-height:50px;
}
</style>
<script type="text/javascript" src="{{STATIC_URL}}js/kinetic-v5.0.0.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.min.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/venobox.js"></script>
<script>
function initialize() { 
addcloud(); //为页面添加遮罩 
document.onreadystatechange = subSomething; //监听加载状态改变 
} 
function addcloud() { 
var bodyWidth = document.documentElement.clientWidth; 
var bodyHeight = Math.max(document.documentElement.clientHeight, document.body.scrollHeight); 
var bgObj = document.createElement("div" ); 
bgObj.setAttribute( 'id', 'bgDiv' ); 
bgObj.style.position = "absolute"; 
bgObj.style.top = "0"; 
bgObj.style.background = "#000000"; 
bgObj.style.filter = "progid:DXImageTransform.Microsoft.Alpha(style=3,opacity=25,finishOpacity=75" ; 
bgObj.style.opacity = "0.5"; 
bgObj.style.left = "0"; 
bgObj.style.width = bodyWidth + "px"; 
bgObj.style.height = bodyHeight + "px"; 
bgObj.style.zIndex = "10000"; //设置它的zindex属性，让这个div在z轴最大，用户点击页面任何东西都不会有反应| 
document.body.appendChild(bgObj); //添加遮罩 
var loadingObj = document.createElement("div"); 
loadingObj.setAttribute( 'id', 'loadingDiv' ); 
loadingObj.style.position = "absolute"; 
loadingObj.style.top = bodyHeight / 2 - 32 + "px"; 
loadingObj.style.left = bodyWidth / 2 + "px"; 
loadingObj.style.background = "url({{STATIC_URL}}img/onload.gif)" ; 
loadingObj.style.backgroundRepeat='no-repeat'
loadingObj.style.width = "100px"; 
loadingObj.style.height = "100px"; 
loadingObj.style.zIndex = "10000"; 
document.body.appendChild(loadingObj); //添加loading动画- 
} 
function removecloud() { 
$( "#loadingDiv").remove(); 
$( "#bgDiv").remove(); 
} 
function subSomething() { 
if (document.readyState == "complete" ) //当页面加载完毕移除页面遮罩，移除loading动画- 
{ 
removecloud(); 
} 
} 
</script>
</head>
<body onload="loadStage()">
    <!--  <a  href="javascript:void(0)" onclick="test_get_code();">测试code</a>-->
    <div id="container"></div>
    <img  class="push" src="{{STATIC_URL}}img/push-57.png"/>
    <img id="game_name" src="{{STATIC_URL}}img/fate-63.png"/>
    <img src="{{STATIC_URL}}img/拼图-68.png" style="position: absolute;top:30px;left: 280px;"/>
<div id="card" style="position: absolute;display:none;" >
<div class="close"></div>
<div id="info" class="card" >
</div>	
<div id="info_clone" style="display: none;">	
   <input type="hidden" id='userId'/>
	<div class="head head_girl">
		<a id="head_url" target="_blank" href=""><img src="" class="img-circle"></a>
	</div>
	<div class="name">
		<h3 ><strong></strong></h3>
	</div>
	<div class="tag" >
		<span class="age"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<span class="city"></span>
	</div>
	<img src='{{STATIC_URL}}img/add_friend.png' title="send message" class="button_type_3" style="top:330px;left: 70px;" onclick="facebook_add_friend();">
	<img src='{{STATIC_URL}}img/message.png' title="add friend" class="button_type_3" style="top:330px;left: 180px;" onclick="facebook_send_message();">
</div>
<div id="photo">
	<div class="scroller">
		<ul class="hoverbox">
		
		</ul>
	</div>
</div>
</div>

<div id="nouser" style="display: none;">
	<div class="close"></div>
	<span class="text-black" id='pair_message'>Oooooops, please try again!</span><br />
	<span class="text-black free_chance">You still have <span id="user_count" style="color: red;"> {{count}} </span>  free chances</span>
	<img src="{{STATIC_URL}}img/拼图-01.png"  style="margin-top: 30px;"/>
	<div class="push try_again " style="left:90px; top: 320px;">Play again</div>
</div>
<div id="game_count_end" style="display: none;">
	<div class="close"></div>
	<span class="text-black" style="line-height:18px;">No more lives today, please come back tomorrow!</span><br />
	<span class="text-black" style="font-size:15px">You can get <img src="/static/img/coin.png" height="25px" width="30px"/> instantly by asking your friends or buying</span><br />
	<img src="{{STATIC_URL}}img/拼图-01.png"  style="margin-top: 30px;"/>
	<div id="buy" class="try_again" style="left:50px; top: 320px;width:50px;background-image: url('/static/img/按钮-66.png');background-repeat:no-repeat;">buy</div>
	<div class="try_again ask_friends" style="left:170px; top: 320px;background-image: url('/static/img/按钮-66.png');background-repeat:no-repeat;width:50px;" >help</div>
</div>
<div id="buy_page">
	<div class="count"><img style="height:30px;width:30px;position:absolute;left:10%;" src="{{STATIC_URL}}img/拼图-18.png"><span class="num" style="top: 20px;position:absolute;left:15%;">×{{count}}</span></div>
<div id="buy">
	<ul>
		<li><img src="{{STATIC_URL}}img/拼图-18.png"><span class="num2">×3</span><span class="text-orange num2" style="margin-left: 50px;">$0.99</span><a onclick='buyCoins(3)'><div class="button_type_1" style="background-image:url({{STATIC_URL}}img/buy.png);height:40px" ></div></a></li>
		<li><img src="{{STATIC_URL}}img/拼图-18.png"><span class="num2">×1</span><span class="text-orange num2" style="margin-left: 41px;">ask friends</span><div class="button_type_1 ask_friends" style="background-image:url({{STATIC_URL}}img/ask_friend.png);height:40px"></div></li>
	</ul>
</div>
</div>

<div id="recevie" style="display: none;">
	<div class="recevie_close"></div>
	<img id="inviteImg" src="{{STATIC_URL}}img/拼图-71.png" style="position: absolute;top:20px;left: 150px;"/>
	<div id="recevie_users">

	</div>
	
<div class="share" style="position: absolute;left: 230px;">thanks&share<span style="color:#FF0000">♥</span></div>
</div>

<div id="invite" style="display: none;">
	<div class="close"></div>
	<span class="num3">{{userCount}}</span>
	<img id="inviteImg" src="{{STATIC_URL}}img/接受邀请-60.png" style="position: absolute;top:5px;left: 60px;"/>
	<span style="left: 120px;position: absolute;top: 80px;">search：</span><input type="text" id='search'  style="left: 200px;position: absolute;top: 80px;width:300px;">
	<div id="users">

	</div>
<div id="user" style="display: none;">
	<div class="user">
	    <input id="uid" type="hidden">
	    <input class="username" type="hidden">
		<div id="head" class="head">
			<img src="" class="img-circle">
		</div>
		<span id="name"></span>
		<input class="checkbox" type="checkbox" name="checkbox1" value="checkbox" > 
	</div>	
</div>
<div id="checkbox1"><input id="send_all_box" type="checkbox" value="checkbox" ><span style="font-size:20px;color: red;">sellect all</div>
<div class="button_type_2">send<span style="color:#FF0000">♥</span></div>
</div>
<div id="record">
	<span style="color:#8c43c4;line-height:19px;font-size: 20px; margin-left: 55px;word-wrap: break-word;letter-spacing: 20px; width: 5px; float:left; ">record</span>
	<ul class="record-user-list"  style="float: left;">
	    {% for facebookUser in facebookUserRecordList %}
	       <li><div class="record-user head_boy "><a target="_blank" href="https://www.facebook.com/{{facebookUser.uid}}" ><img src="{{facebookUser.smallAvatar}}" class="img-circle" title="username:{{facebookUser.username}}  location:{{facebookUser.location}} age:{{facebookUser.age}}"><div  class=" {% ifequal facebookUser.online 1%}online{%else%}outline{%endifequal %}"></div></a></div></li>
	    {% endfor %}
	</ul>
</div>
<div class="record-user head_boy record-user-clone"  style="display: none;"><a target="_blank" href="" ><img src="" class="img-circle" title="" ></a></div>
<div id="record-cover"></div>
<div id="information" style="display: none;" class='information'>
<span class="msg"></span>
</div>
<script type="text/javascript">
var  game_count=null;
var  type=false;
var selectedPieces = new Array(),
	piecesArray=new Array();
var pieces = 8,
	size = 400,
	add = 4;
	
var color = new Array("#ffd62c","#9164ff");
var position = new Array({X:add,Y:size/2+add},{X:size/2-size/4*Math.sqrt(2)+add,Y:size/2-size/4*Math.sqrt(2)+add},{X:size/2+add,Y:add},{X:size/2+size/4*Math.sqrt(2)+add,Y:size/2-size/4*Math.sqrt(2)+add},{X:size+add,Y:size/2+add},{X:size/2+size/4*Math.sqrt(2)+add,Y:size/2+size/4*Math.sqrt(2)+add},{X:size/2+add,Y:size+add},{X:size/2-size/4*Math.sqrt(2)+add,Y:size/2+size/4*Math.sqrt(2)+add},{X:add,Y:size/2+add});
function loadStage() {
    var stage = new Kinetic.Stage({
		container: "container",
		width: 408,
		height: 408
        });
    layer = new Kinetic.Layer();
	for(i=0;i<pieces;i++){
		piecesArray[i] = new Object();
		piecesArray[i].shape=new Kinetic.Shape({
            drawFunc: function(i){
                return function(context) {
					context.beginPath();
					context.moveTo(position[i].X,position[i].Y);
					context.arc(size/2+4,size/2+4,size/2,Math.PI+Math.PI/4*i,Math.PI+Math.PI/4*(i+1));
					context.lineTo(size/2+4,size/2+4);
					context.lineTo(position[i].X,position[i].Y);
					context.fillStrokeShape(this);
                    }
                 }(i),
					fill: color[i%2],
					id:i,
					opacity:0.5,
					stroke: "#ffffff",
					strokeWidth: 4,
					draggable: false
                    });
//		piecesArray[i].shape.disableStroke();
  		piecesArray[i].shape.on("mousedown", function(){
  		this.setOpacity(0.5/this.getOpacity());
//		this.setStrokeEnabled(!this.getStrokeEnabled());
  		layer.batchDraw();
         }); 
        layer.add(piecesArray[i].shape);

	}
	stage.add(layer);

        }

       var index=0,           //当前亮区位置
       prevIndex=0,          //前一位置
       Speed=200,           //初始速度
       Time,               //定义对象
       EndIndex=0,        //决定在哪一格变慢
       cycle=0,          //转动圈数 
       StartCycle=0,  
       EndCycle=0,      //计算圈数
       flag=false,     //结束转动标志 
       quick=0;       //加速
        
       function StartGame(){
    	   $('#nouser').hide('slow');
    	   $('.push').unbind();
    	   for(var i=0;i<pieces;i++){
            	piecesArray[i].shape.opacity(0.5)
            }
	     clearInterval(Time);
         cycle=0;
         StartCycle=2;
         flag=false;
         type=10;
         selectedPieces = new Array();
        Time = setInterval(Star,Speed);
         $.getJSON("/game/jigsaw/",{number:{{count}},uid:{{uid}}},function(data) {
        	 if(data['login']=='invalid'){window.location =data['redirectURL'];}
        	 if(data[0]=='0'){
        		  $('#tab').hide()
        		  type=0;
        	 }
        	 if(data[0]=='1'){
        		  $('#tab').hide()
        		  type=1;
        		 }
        	 if(data[0]=='2'){
        	 var template = $('#info_clone').clone();
        	 template.find('#userId').val(data[2]['uid']);
        	 template.find('.img-circle').attr('src',data[2]['avatar']);
        	 template.find('#head_url').attr('href',"https://www.facebook.com/"+data[2]['uid'])
        	 if (data[2]['username'].length>26){
        		 var username=data[2]['username'].substring(0,26)
        		 template.find('strong').html(username+'...');
        	 }else{
        		 template.find('strong').html(data[2]['username']);
        	 }
        	 template.find('strong').attr('title',data[2]['username'])
        	 if (data[2]['age']!=null){
        		 template.find('.age').html(data[2]['age'].toString()+'岁');
        	 }
        	 if (data[2]['age']!=null){
        		 template.find('.city').html(data[2]['city'])
        	 }
        	  $('#info').html('');
        	 $('#info').append(template.children());
        	 game_count=data[2]['game_count'].toString()
        	 //添加匹配记录
        	 var record_user=$('.record-user-clone').clone();
        	 record_user.find('.img-circle').attr('src',data[2]['smallAvatar']);
        	 record_user.find('.img-circle').attr('title','username:'+data[2]['username']+' '+'location:'+data[2]['city']);
        	 record_user.find('a').attr('href',"https://www.facebook.com/"+data[2]['uid']);
        	 record_user.removeClass('record-user-clone')
        	 $('.record-user-list').prepend("<li>").append(record_user).append('</li>');
        	 type=2
        	 facebookPhotoList=data[2]['facebookPhotoList']
        	 facebookPhotoList=$.parseJSON(facebookPhotoList)
        	 $('.hoverbox').children().remove()
        	  $('#tab').show()
        	 for(var i=0 ;i<facebookPhotoList.length;i++){
        		 if (i<6){
        			 $('.hoverbox').append('<li><a id="firstlink" class="venobox" data-gall="gall1" href='+facebookPhotoList[i].fields.bigPhoto+' title='+facebookPhotoList[i].fields.description+'><img alt="demo1" src='+facebookPhotoList[i].fields.smailPhoto+' title='+facebookPhotoList[i].fields.description+'></a></li>')
        		 }else{
        			 $('.hoverbox').append('<li><a id="firstlink" style="display:none;" class="venobox" data-gall="gall1" href='+facebookPhotoList[i].fields.bigPhoto+' title='+facebookPhotoList[i].fields.description+'><img alt="demo1" src='+facebookPhotoList[i].fields.smailPhoto+' title='+facebookPhotoList[i].fields.description+'></a></li>')
        		 }
        	     
        	 }
        	
        	  }
        	 clearInterval(Time);
        	 if(type==1){
        	  $('.push').click(StartGame);
           	  $('#game_count_end').show('slow');
           	  return;
             }
        	 piece = data[1];
        	 EndIndex = piece[piece.length-1];
        	 EndCycle=StartCycle+piece.length;
        	  Time = setInterval(Star,Speed); 

        	 
        	 //$('#count').html('游戏次数:'+data['count']);
        	 });
     }
       
        function Star(num){
            //跑马灯变速
            if(flag==false){
              //走五格开始加速
             if(quick==5){
                 clearInterval(Time);
                 Speed=100;
                 Time=setInterval(Star,Speed);
             }
             //跑N圈减速
             if(cycle>=EndCycle && index==parseInt(EndIndex) && type<4){
                 clearInterval(Time);
                 flag=true;       //触发结束			 
                 Time=setInterval(Star,Speed);
             }
             
             if(cycle >= StartCycle && cycle <= EndCycle){
             	selectedPieces.push(piece[cycle-StartCycle-1]);
             }
             
             if(cycle==EndCycle){
             	clearInterval(Time);
             	Speed=300;
             	Time=setInterval(Star,Speed);
             }
            }  
                   
            if(index>=piecesArray.length){
                index=0;
                cycle++;
            }
            
           //结束转动并选中号码
         if(flag==true){ 
          quick=0;
          clearInterval(Time);
          venobox();
		  $('.push').click(StartGame);
          if (type==2){
        	  set_game_count(game_count)
        	  $('.record-user-list').children().last().show()
        	  $('#card').show('slow');
          }else if(type==0){
        	  $('#nouser').show('slow');
          }else if(type==1){
        	  $('#game_count_end').show('slow');
          }
         
            }
            if(index>0)
                prevIndex=index-1;
            else{
                prevIndex=piecesArray.length-1;
            }
            piecesArray[index].shape.opacity(1);
//          piecesArray[index].shape.stroke('#aeffae');
            if($.inArray(prevIndex, selectedPieces) < 0)
            	piecesArray[prevIndex].shape.opacity(0.5);
//          	piecesArray[prevIndex].shape.stroke('#fff')
            layer.batchDraw();
            index++;
            quick++;
        }

        function contains(obj,arry){
        	var i = arry.length;
        		while(i--){
        			if(arry[i]===obj){
        				return true;
        			}
        		}
        	return false;	
        }

        function venobox(){
        	$('.venobox').venobox({
        		numeratio: true,
        		border: '0'
        	});
        }
	$(document).ready(function(){
		initialize()
		var appId='400350543428768'
			  $.ajaxSetup({ cache: true });
			  $.getScript('//connect.facebook.net/en_UK/all.js', function(){
			    FB.init({
			      appId:appId,
			      status     : true,
			      cookie     : true,
			      xfbml      : true,
			      frictionlessRequests : true
			    });     
			  });
		//转盘点击事件
		$('.push').click(StartGame);
		/*$('.push').mouseover(function(){
			$(this).attr('src','/static/img/push-58.png')
		}).mouseleave(function(){
			$(this).attr('src','/static/img/push-57.png')
		}); */
		$('#buy').click(function(){buyCoins(3)});
		$('#send_all_box').click(
				/* if $('#send_all_box').attr('checked') */
				function(){
					$("[name='checkbox1']:visible").attr('checked','true');} 
		);
		$('.close').click(function(){
			$(this).parent().hide('slow');
		});
		$('.recevie_close').click(function(){
			$(this).parent().hide('slow');
			if ({{userCount}}>0){
				$('#invite').show('slow');
			}
		});
		
		$('.button_type_1').mouseover(function(){
			if (this.style.backgroundImage=='url("/static/img/buy.png")' ||this.style.backgroundImage=="url(http://127.0.0.1/static/img/buy.png)"){
			   this.style.backgroundImage='url("/static/img/buy2.png")';
			   }else if(this.style.backgroundImage=='url("/static/img/ask_friend.png")' ||this.style.backgroundImage=="url(http://127.0.0.1/static/img/ask_friend.png)"){
			   this.style.backgroundImage='url("/static/img/ask_friend2.png")';
			   }
			}).mouseleave(function(){
			 if (this.style.backgroundImage=='url("/static/img/buy2.png")' ||this.style.backgroundImage=="url(http://127.0.0.1/static/img/buy2.png)"){
			   this.style.backgroundImage='url("/static/img/buy.png")';
			   }else if(this.style.backgroundImage=='url("/static/img/ask_friend2.png")' ||this.style.backgroundImage=="url(http://127.0.0.1/static/img/ask_friend2.png)"){
			   this.style.backgroundImage='url("/static/img/ask_friend.png")';
			   }
			});
		
		$('#search').keyup(function(){
			delay(function(){
				var username=$('#search').val().toLowerCase();
				match='.username:not([value*="'+username+'"])'
				$('#users ').children().show()
				if (username.trim()!=""){
					 var choice=$('#users '+match+'').parent()
					 choice.hide('slow')
				}
			},800)
			
			
		});
		
		 var delay = (function(){
			  var timer = 0;
			  return function(callback, ms){
			    clearTimeout (timer);
			    timer = setTimeout(callback, ms);
			  };
			})();

		$('#buy_button').click(function(){
			$('#buy_page').show('slow');
		});
		
		
		//送你心的好友
		receiveUsers={{inviteNonfirmList|safe}}
		if (receiveUsers.length>0){
			new User(receiveUsers,3);
			$('#recevie').show('slow');
		}
		
		//请求送心的好友
		users ={{data|safe}}
		if ({{userCount}}>0){
	    //users = [{'gender':'M','uid':'sds','src':'.\img','name':'Hlk01'},{'gender':'M','uid':'22','src':'.\img','name':'Hlk11'},{'gender':'M','uid':'sds','src':'.\img','name':'Hlk21'},{'gender':'M','uid':'sds','src':'.\img','name':'Hlk3'},{'gender':'M','uid':'sds','src':'.\img','name':'Hlk4'},{'gender':'M','uid':'sds','src':'.\img','name':'Hlk5'},{'gender':'M','uid':'sds','src':'.\img','name':'Hlk6'},{'gender':'M','uid':'sds','src':'.\img','name':'Hlk7'},{'gender':'M','uid':'sds','src':'.\img','name':'Hlk7'}];
		new User(users,1);
		if (receiveUsers.length<=0){
			$('#invite').show('slow');
		  }
		} 
		
	     //邀请好友
		$('.ask_friends').click(function(){
		    page = 0;
		    $('#search').val("");
		    $('#invite').find('#inviteImg').attr('src','{{STATIC_URL}}img/拼图-83.png')
		    $('#invite').find('.num3').remove()
			/* $('#invite').find('.num3').html('ask your friends')
			$('#invite').find('.num3').removeClass('num3').addClass('num4') 
		    $('#invite').find('#inviteImg').remove();*/
			$('#users').children().remove()
			users= new Array();
	       FB.api({
	                method: 'fql.query',
	                query:'SELECT uid, name, is_app_user, pic_square FROM user WHERE uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) '
			        },
					function(data){
				for(i=0;i<data.length;i++){
					user={'gender':'M','uid':data[i].uid ,'avatar':data[i]. pic_square,'username':data[i].name }
					 users.push(user)
				}
				 new User(users,2);
				 $('#sendALL').show()
				$('#invite').show('slow');
				
			});  
		    /*  for (i=0;i<200;i++)
		    	{
		    	users.push({'gender':'M','uid':133186198+i,'avatar':'.\img','username':'Hlk01 '+i.toString()})
		    	}    
			  users.push({'gender':'M','uid':133186198+i,'avatar':'.\img','username':'Jin '+i.toString()}) */
			new User(users,2);
			$('#invite').show('slow');
		});
	     
		$('[id^=record]').mouseover(function(){
			$('#record-cover').animate({left:"82px"},0);
			$('#record').animate({left:"0px"},0);
		});
		
		$('[id^=record]').mouseout(function(){
			$('#record-cover').animate({left:"42px"},0);
			$('#record').animate({left:"-40px"},0);
		});
		
		//发送所有
		$('#sendALL').click(function(){
		    var sendUIDs = '';
		   for(i=0;i<users.length;i++){
		    sendUIDs  =sendUIDs+users[i].uid+',';
		    if ((i!=0) && (i%49==0)){
				// Use FB.ui to send the Request(s)
				   FB.ui({method: 'apprequests',
					     to: sendUIDs,
					     title: 'My Great Invite for fate',
					     message: 'Check out this fate App!',
					   }, function(data){
							console.log(data);
							if (data.error_code==4201){
							}
						});
			    sendUIDs = '';  
			   } 
		   }
		  if (sendUIDs != ''){
		    	// Use FB.ui to send the Request(s)
				   FB.ui({method: 'apprequests',
					     to: sendUIDs,
					     title: 'My Great Invite for fate',
					     message: 'Check out this fate App!',
					   }, function(data){
							console.log(data);
							if (data.error_code==4201){
							}
						});
		    } 
		});
	});
	
	window.User = function(Users,type){
		for(i=0;i<Users.length;i++){
			gender = Users[i].gender;
			var template = $('#user').clone();
			var head = template.find('#head');
			var name = template.find('#name');
			if(type==2){
				head.removeClass('head').addClass('head_ask_friends')
			}
			if(gender=='M'){
				head.addClass('head_boy');
				if(type==2){
					name.addClass('name_boy_invite');
				}else{
					name.addClass('name_boy');
				}
			}else{
				head.addClass('head_girl');
				if(type==2){
					name.addClass('name_girl_invite');
				}else{
					name.addClass('name_girl');
				}
				
			}
			head.children().attr('src',Users[i].avatar);
			name.html(Users[i].username);
			template.find('#uid').val(Users[i].uid)
			template.find('.username').val(Users[i].username.toLowerCase())
			if(type==3){
				template.find('.checkbox').remove();
				$('#recevie_users').append(template.html());
			}else{
				$('#users').append(template.html());
			}
			
		}
		if(type==1){
			$('.button_type_2').unbind();
			$('.button_type_2').on('click',renderMFS);
		}
		if(type==2){
			$('.button_type_2').unbind();
			$('.button_type_2').on('click',inivteF);
			
		}
		if(type==3){
			$('.share').on('click',share);
		}
		
		
		//接收生命请求
		function renderMFS(uid) {
			var uids=$('#users').find('input[type=checkbox]:checkbox:checked').parent().find('#uid');
			if (users.length==0){
				alert('Please choose!');return;
			}
			uidList=Array();
			for(var i=0 ;i<uids.length;i++){
				uid=uids[i].value;
				uidList.push(uid)
			}
			$.getJSON('/game/confirm_request_life/',{uidList:JSON.stringify(uidList)},function(data){
				if (data['result']=='success'){
					/* $('.count').find('.num1').html('x'+data['count'])
					 $('.count').find('.num').html('x'+data['count']) */
					 notify('send success!')
					 $('#invite').hide('slow');
				}else{
					 notify('error type!')
				}
			});}
		
		//邀请好友
		function inivteF(){
			var uids=$('#users').find('input[type=checkbox]:checkbox:checked').parent().find('#uid');
			if (uids.length==0){
				alert('Please choose!');return;
			}
			uidList=Array();
			for(var i=0 ;i<uids.length;i++){
				uid=uids[i].value;
				uidList.push(uid)
			}
			var sendUIDs = '';
			if (uidList.length>50){
				for(var i=0;i<49;i++){
					n=Math.round(Math.random()*uidList.length-1)
					sendUIDs  =sendUIDs+uidList[n]+',';
					uidList.splice(n,1); 
				}
			}else{
				for(var i=0;i<uidList.length;i++){
					sendUIDs  =sendUIDs+uidList[i]+',';
				}
			}
			// Use FB.ui to send the Request(s)
				   FB.ui({method: 'apprequests',
					     title: 'My Great Invite for fate',
					     message: 'Check out this fate App!',
					     to: sendUIDs
					   }, function(data){
							console.log(data);
							if (data.error_code==null){
								$('.close').click();
							}
						});
		};
	
	}
	
	function set_game_count(count){
		$('.count').find('.num').html('x'+count)
		$('#user_count').html(count)
	}
	
	
	function share(){
		$.getJSON('/game/feed_on_wall/',function(data){
		 if (data['result']=='success'){
			 notify('share success!');
			 $('.recevie_close').click();
		 }else if(data['result']=='nopermission'){
			 FB.login(function(response) {
				 console.log(response)
				 if(response["status"]=="connected"){
					 $.getJSON('/game/feed_on_wall/',{authResponse:JSON.stringify(response['authResponse'])},function(data){
						 if (data['result']=='success'){
							 notify('share success!');
					 }
					 $('.recevie_close').click();
				 })
				 }}, {scope: 'publish_actions'});
	}
	})
	}
</script>
 <script>
//更新拼爱币
function updateCoins(quantity,operation){
	
	gold=$('.count').find('.num1')
	price=(gold.html()).substring(1)
	if(operation=='add'){
		price=parseInt(price)+quantity
	}else if(operation=='sub'){
		price=parseInt(price)-quantity
	}else{
		return;
	}
	$('.count').find('.num1').html('x'+price.toString())
	$('.count').find('.num').html('x'+price.toString())
}
//更新游戏次数
function updateGameCount(count,operation){
	obj= $('#count').find('.num')
	gameCount=(obj.html()).substring(1)
	if(operation=='add'){
		gameCount=parseInt(gameCount)+count
	}else if(operation=='sub'){
		gameCount=parseInt(gameCount)-count
	}else{
		return;
	}
	obj.html('x'+gameCount.toString())
}
//兑换游戏次数
function exchange(gameCount,price){
	$.getJSON('/pay_app/exchange_game_count/',{'gameCount':gameCount},function(data){
		if (data['result']='success'){
			updateGameCount(gameCount,'add');
			updateCoins(price,'sub')
		}else{
			alert('兑换失败请重试！')
		}
		
	});
}

//购买拼爱币
function buyCoins(quantity) {
	     FB.ui({
	      method: 'pay',
	      action: 'purchaseitem',
	      product: 'www.pinpinlove.com/pay/icon/',
	      quantity: quantity
	    },
	    function(data) {
	        console.log(data);
	        $.getJSON('/pay/pay_detail/',{data:JSON.stringify(data)},function(data){
	  		  if (data['result']=='success'){
        	             set_game_count(data['game_count'].toString())
	  	      	}else{
	  	      		alert('支付失败！')
	  	      	}
	  	});
	      }
	  ); 
	  /* var data={
		  payment_id: "495869257196092",
		  amount: "5.00",
		  currency: "USD",
		  quantity: "1", 
		  request_id: "60046727",
		  status: "completed", 
		  signed_request: "7QYHzKqKByA7fjiqJUh2bxFvEdqdvn0n_y1zYiyN6tg.eyJhbGCJxdWFudGl0eSI6IjEiLCJzdGF0dXMiOiJjb21wbGV0ZWQifQ"
		}
	  $.getJSON('/pay/pay_detail/',{data:JSON.stringify(data)},function(data){
		  if (data['result']=='success'){
	      		quantity=data.quantity
			        updateCoins(parseInt(quantity),'add')
	      	}else{
	      		alert('支付失败！')
	      	} 
	});*/
}
// Load the SDK Asynchronously
(function(d){
  var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
  if (d.getElementById(id)) { return; }
  js = d.createElement('script'); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js";
  ref.parentNode.insertBefore(js, ref);
}(document));
//用facebook私信
function facebook_send_message() {
	var userId=$('#userId').val()
    FB.ui({
        method: 'send',
        name:'fate',
        description:'Find your everyday friend on facebook!',
        picture:'http://www.pinlove.com/static/img/coin.png',
        link: 'apps.facebook.com/pinloveapp/?fb_source=bookmark_apps&ref=bookmarks&count=0&fb_bmpos=3_0',
        to:userId

    });
}
//添加好友
function facebook_add_friend() {
	var userId=$('#userId').val()
FB.ui(
	     { 
	      method: 'friends', 
	      id:userId
	     }, 
	     function(param){

	      console.log(param);

	     }
	    );
};

//邀请好友
function inivteFriends(){
	FB.ui({method: 'apprequests',
		  message: 'pinlove'
		}, function(data){
			console.log(data);
		});
};


    function deleteRequest() {
      requestId=$('.list-inline').children().children().val()
	  FB.api(requestId, 'delete', function(response) {
	    console.log(response);
	  });
	}
    
    function getRequest(){
    	FB.api(
    		    "/me/apprequests",
    		    function (response) {
    		    	  console.log(response);
    		    }
    		);
    }
    function notify(text){
    	$('.information').show()
 	   $('.information').children().html(text)
 	  // $('.information').show(300).delay(3000).hide(300)
 	  $('.information').hide(2300)
    }
    function recommend_hisotry(){
    	$.getJSON('/game/recommend_history/',function(data){
    		str=''
    		for(var i=0;i<data.length;i++){
    			str=str+'name：'+data[i].username+' ';
    			str=str+'city：'+data[i].location+'\n';
    		}
    		alert(str)
    	});
    	}
    
    function feeds(){
    	FB.ui({
    		  method: 'feed',
    		  link: 'https://developers.facebook.com/docs/dialogs/',
    		  app_id:'400350543428768',
    		  caption: 'fate',
    		  description: "an interesting game ",
              picture: "http://www.pinlove.com/static/img/coin.png"
    		}, function(response){});
    }
    function test_get_code(){
    	$.getJSON('/game/test_get_code',function(data){
    		console.log(data)
    	})
    }
</script>
</body>
</html>
